digraph FAN_Architecture {
    rankdir=LR;
    size="11,8.5";
    dpi=300;
    
    // Настройки узлов - компактные, но с полным текстом
    node [fontname="Arial", fontsize=9, shape=box, style=filled, penwidth=1.2];
    edge [fontname="Arial", fontsize=8, penwidth=1.2, color="#333333"];
    
    // Входные данные - светлые с темным текстом
    text_input [label="Текстовый вход\n\"Золотистый ретривер\"", fillcolor="#E6F3FF", shape=ellipse, fontcolor="#000000", penwidth=2];
    image_input [label="Изображение\n224×224×3", fillcolor="#E6FFE6", shape=ellipse, fontcolor="#000000", penwidth=2];
    
    // Текстовый путь - светлые серые
    bert_tokenizer [label="BERT Токенизатор", fillcolor="#F0F0F0", fontcolor="#000000"];
    bert_encoder [label="BERT Энкодер\n12 слоев", fillcolor="#E0E0E0", fontcolor="#000000"];
    text_projection [label="Текстовая проекция\nLinear(768→512)", fillcolor="#D0D0D0", fontcolor="#000000"];
    
    // Путь изображения - светлые серые
    resnet_backbone [label="ResNet Основа", fillcolor="#F0F0F0", fontcolor="#000000"];
    image_projection [label="Проекция изображения\nLinear(2048→512)", fillcolor="#E0E0E0", fontcolor="#000000"];
    
    // Механизм внимания - средние серые
    query_proj [label="Запрос\nLinear(512→512)", fillcolor="#B8B8B8", fontcolor="#000000"];
    key_proj [label="Ключ\nLinear(512→512)", fillcolor="#B8B8B8", fontcolor="#000000"];
    value_proj [label="Значение\nLinear(512→512)", fillcolor="#B8B8B8", fontcolor="#000000"];
    
    // НЕЧЕТКИЕ КОМПОНЕНТЫ - подробное объяснение
    fuzzy_explanation [label="НЕЧЕТКИЕ КОМПОНЕНТЫ\n\nНечеткие множества определяют:\n• Степени принадлежности признаков\n• Мягкие границы между классами\n• Обработку неопределенности данных", 
                       fillcolor="#FFE6E6", shape=note, fontcolor="#000000", penwidth=2];
    
    // Конкретные нечеткие множества с названиями
    fuzzy_set_text [label="Множество текстовых признаков\nμ₁: Семантическое сходство\nμ₂: Важность слов\nμ₃: Контекстная релевантность", 
                    fillcolor="#FFB3B3", shape=diamond, fontcolor="#000000"];
    fuzzy_set_image [label="Множество признаков изображения\nμ₄: Визуальная значимость\nμ₅: Границы объектов\nμ₆: Цветовые паттерны", 
                     fillcolor="#FFB3B3", shape=diamond, fontcolor="#000000"];
    fuzzy_set_attention [label="Множество внимания\nμ₇: Межмодальное выравнивание", 
                         fillcolor="#FFB3B3", shape=diamond, fontcolor="#000000"];
    
    // Параметры нечетких множеств
    fuzzy_centers [label="Центры нечетких множеств\nμ₁, μ₂, ..., μ₇\n(Обучаемые параметры)", 
                   fillcolor="#606060", shape=ellipse, fontcolor="#FFFFFF"];
    fuzzy_widths [label="Ширины нечетких множеств\nσ₁, σ₂, ..., σ₇\n(Обучаемые параметры)", 
                  fillcolor="#606060", shape=ellipse, fontcolor="#FFFFFF"];
    
    // Функция принадлежности Белла с формулой
    bell_membership [label="Функция принадлежности Белла\nμ(x) = 1/(1+((x-μ)/σ)²)\n\nГде:\n• x = значение входного признака\n• μ = центр (обучаемый)\n• σ = ширина (обучаемая)", 
                     fillcolor="#404040", shape=ellipse, fontcolor="#FFFFFF"];
    
    // Вычисление внимания с нечеткой модуляцией
    attention_weights [label="Нечетко-модулированное внимание\nSoftmax(QKᵀ/√d + F(μ,σ))\n\nF(μ,σ) = значения нечеткой принадлежности\nмодулируют веса внимания", 
                       fillcolor="#A0A0A0", fontcolor="#000000"];
    attended_values [label="Взвешенные значения\nВнимание × V", fillcolor="#909090", fontcolor="#000000"];
    
    // Слияние - светлые серые
    concat_fusion [label="Конкатенация\n[текст; изображение; внимание]", fillcolor="#F5F5F5", fontcolor="#000000"];
    fusion_layer [label="Слой слияния\nLinear(1536→512)", fillcolor="#E8E8E8", fontcolor="#000000"];
    dropout [label="Dropout + ReLU", fillcolor="#D8D8D8", fontcolor="#000000"];
    
    // Классификатор - темные с белым текстом
    classifier [label="Классификатор\nLinear(512→num_classes)", fillcolor="#505050", fontcolor="#FFFFFF"];
    softmax [label="Softmax", fillcolor="#404040", fontcolor="#FFFFFF"];
    prediction [label="Предсказание\nКласс + Уверенность", fillcolor="#303030", shape=ellipse, fontcolor="#FFFFFF"];
    
    // Соединения - текстовый путь
    text_input -> bert_tokenizer [label="Токенизация", color="#000000"];
    bert_tokenizer -> bert_encoder [label="Кодирование", color="#000000"];
    bert_encoder -> text_projection [label="Проекция", color="#000000"];
    
    // Соединения - путь изображения
    image_input -> resnet_backbone [label="Извлечение", color="#000000"];
    resnet_backbone -> image_projection [label="Проекция", color="#000000"];
    
    // Соединения - механизм внимания
    text_projection -> query_proj [label="Q", color="#000000"];
    text_projection -> key_proj [label="K", color="#000000"];
    text_projection -> value_proj [label="V", color="#000000"];
    
    // НЕЧЕТКИЕ СОЕДИНЕНИЯ - показываем откуда берется нечеткость
    fuzzy_explanation -> fuzzy_set_text [label="Определяет", color="#FF0000", penwidth=2];
    fuzzy_explanation -> fuzzy_set_image [label="Определяет", color="#FF0000", penwidth=2];
    fuzzy_explanation -> fuzzy_set_attention [label="Определяет", color="#FF0000", penwidth=2];
    
    // Параметры нечетких множеств
    fuzzy_set_text -> fuzzy_centers [label="μ₁,μ₂,μ₃", color="#FF0000", penwidth=2];
    fuzzy_set_image -> fuzzy_centers [label="μ₄,μ₅,μ₆", color="#FF0000", penwidth=2];
    fuzzy_set_attention -> fuzzy_centers [label="μ₇", color="#FF0000", penwidth=2];
    
    fuzzy_set_text -> fuzzy_widths [label="σ₁,σ₂,σ₃", color="#FF0000", penwidth=2];
    fuzzy_set_image -> fuzzy_widths [label="σ₄,σ₅,σ₆", color="#FF0000", penwidth=2];
    fuzzy_set_attention -> fuzzy_widths [label="σ₇", color="#FF0000", penwidth=2];
    
    // Функция Белла
    fuzzy_centers -> bell_membership [label="μ", color="#FF0000", penwidth=2];
    fuzzy_widths -> bell_membership [label="σ", color="#FF0000", penwidth=2];
    
    // Внимание с нечеткой модуляцией
    query_proj -> attention_weights [label="Q", color="#000000"];
    key_proj -> attention_weights [label="K", color="#000000"];
    bell_membership -> attention_weights [label="Нечеткая модуляция\nF(μ,σ)", color="#FF0000", penwidth=2];
    
    attention_weights -> attended_values [label="Внимание", color="#000000"];
    value_proj -> attended_values [label="V", color="#000000"];
    
    // Соединения - слияние
    text_projection -> concat_fusion [label="Текстовые признаки", color="#000000"];
    image_projection -> concat_fusion [label="Признаки изображения", color="#000000"];
    attended_values -> concat_fusion [label="Взвешенные признаки", color="#000000"];
    
    concat_fusion -> fusion_layer [label="Слияние", color="#000000"];
    fusion_layer -> dropout [label="Обработка", color="#000000"];
    
    // Соединения - классификация
    dropout -> classifier [label="Классификация", color="#000000"];
    classifier -> softmax [label="Нормализация", color="#000000"];
    softmax -> prediction [label="Выход", color="#000000"];
    
    // Математическая формула - четкий контраст
    formula [label="Формула нечеткого внимания:\nAttention(Q,K,V) = softmax(QK^T/√d + F(μ,σ))V\n\nГде F(μ,σ) = значения нечеткой принадлежности\nмодулируют веса внимания", 
             fillcolor="#FFFFFF", shape=plaintext, fontsize=8, fontcolor="#000000", penwidth=1];
    
    // Соединяем формулу
    formula -> attention_weights [style=dashed, color="#666666"];
}
